import streamlit as st
import pandas as pd
import random

# ==========================================
# 1. é¡µé¢é…ç½®ä¸æ ·å¼
# ==========================================
st.set_page_config(
    page_title="çœ¼ç§‘é«˜åˆ†é€»è¾‘ç«™",
    page_icon="ğŸ‘ï¸",
    layout="wide",
    initial_sidebar_state="expanded"
)

# è‡ªå®šä¹‰CSSï¼Œä¼˜åŒ–è¡¨æ ¼å’Œå­—ä½“
st.markdown("""
<style>
    .big-font { font-size:24px !important; font-weight: bold; color: #2c3e50; }
    .highlight { background-color: #f1f8ff; padding: 10px; border-radius: 5px; border-left: 5px solid #3498db; }
    .mnemonic { background-color: #fff3cd; padding: 15px; border-radius: 10px; font-style: italic; }
    .stTabs [data-baseweb="tab-list"] button [data-testid="stMarkdownContainer"] p {
    font-size: 18px;
    }
</style>
""", unsafe_allow_html=True)

# ==========================================
# 2. æ•°æ®æ¨¡æ‹Ÿ (åŸºäºæ‚¨çš„æ–‡æ¡£å†…å®¹)
# ==========================================

# å……è¡€é‰´åˆ«æ•°æ®
red_eye_data = {
    "é‰´åˆ«ç‚¹": ["åˆ«å", "è¡€ç®¡æ¥æº", "å……è¡€å¤–è§‚", "å……è¡€éƒ¨ä½", "ç§»åŠ¨æ€§", "è‚¾ä¸Šè…ºç´ è¯•éªŒ", "ä¼´éšç—‡çŠ¶", "å¸¸è§ç—…å˜"],
    "ç»“è†œå……è¡€ (Conjunctival)": ["è¡¨å±‚å……è¡€", "ç»“è†œååŠ¨è„‰ï¼ˆçœ¼ç‘åŠ¨è„‰å¼“ï¼‰", "é²œçº¢è‰²ï¼Œæ ‘æçŠ¶/ç½‘çŠ¶", "ç©¹éš†éƒ¨æ˜æ˜¾ï¼Œå‘è§’è†œå˜æ·¡", "æ¨å¾—åŠ¨", "æ•æ„Ÿï¼ˆç«‹å³æ¶ˆå¤±ï¼‰", "å¼‚ç‰©æ„Ÿã€åˆ†æ³Œç‰©å¤š", "ç»“è†œç‚"],
    "ç«çŠ¶å……è¡€ (Ciliary)": ["æ·±å±‚å……è¡€", "è§’è†œç¼˜è¡€ç®¡ç½‘ï¼ˆç«çŠ¶å‰åŠ¨è„‰ï¼‰", "ç´«çº¢è‰²ï¼Œæ¯›åˆ·çŠ¶/æ”¾å°„çŠ¶", "è§’è†œç¼˜æ˜æ˜¾ï¼Œå‘åå˜æ·¡", "æ¨ä¸åŠ¨", "ä¸æ•æ„Ÿ", "ç–¼ç—›ã€ç•å…‰ã€æµæ³ª", "è§’è†œç‚ã€è™¹ç«ç‚ã€é’å…‰çœ¼"]
}

# æ¯æ—¥å£è¯€åº“
mnemonics = [
    "ç»“è†œé²œçº¢ç©¹éš†èµ·ï¼Œæ¨ä¹‹å¯åŠ¨è‚¾ä¸Šæ•ã€‚ï¼ˆç»“è†œå……è¡€ç‰¹å¾ï¼‰",
    "ç«çŠ¶ç´«çº¢è§’è†œç»•ï¼Œæ¨ä¹‹ä¸åŠ¨ç—›æ³ªé¢‘ã€‚ï¼ˆç«çŠ¶å……è¡€ç‰¹å¾ï¼‰",
    "ç»†èŒæ€¥ï¼Œè„“æ€§å¤šï¼›ç—…æ¯’æ…¢ï¼Œæ°´æ ·ç£¨ã€‚ï¼ˆè§’è†œç‚é‰´åˆ«ï¼‰",
    "æˆ¿æ°´æµï¼šç‚¹å°æ€»å›Šé¼»ä¸‹ï¼Œæœ€åæµè¿›ä¸‹é¼»é“ã€‚",
    "ç³å­”æ¢¨å½¢å°–ç«¯æŒ‡ï¼Œè™¹è†œåµŒé¡¿è¦æ³¨æ„ã€‚ï¼ˆçœ¼çƒç©¿é€šä¼¤ï¼‰"
]

# ç—…ä¾‹åº“
cases = [
    {
        "title": "å†œæ°‘ä¼¯ä¼¯çš„ç‰ç±³å¶",
        "desc": "ä¸€ä½50å²ç”·æ€§å†œæ°‘ï¼Œè¢«ç‰ç±³å¶åˆ’ä¼¤å³çœ¼å3å¤©ã€‚çœ¼éƒ¨ç–¼ç—›ã€ç•å…‰ã€‚æ£€æŸ¥å‘ç°è§’è†œä¸­å¤®æœ‰ç°ç™½è‰²æºƒç–¡ï¼Œè¡¨é¢å¹²ç‡¥ï¼Œè¾¹ç¼˜å‘ˆç¾½æ¯›çŠ¶ï¼Œä¼´æœ‰å«æ˜Ÿç¶ã€‚",
        "options": ["ç»†èŒæ€§è§’è†œç‚", "çœŸèŒæ€§è§’è†œç‚", "ç—…æ¯’æ€§è§’è†œç‚", "æ£˜é˜¿ç±³å·´è§’è†œç‚"],
        "answer": "çœŸèŒæ€§è§’è†œç‚",
        "explanation": "å…³é”®è¯åŒ¹é…ï¼šæ¤ç‰©å¤–ä¼¤å²ï¼ˆç‰ç±³å¶ï¼‰ + ç¾½æ¯›çŠ¶/å«æ˜Ÿç¶ = çœŸèŒæ€§è§’è†œç‚ã€‚æ²»ç–—å¿Œæ¿€ç´ ï¼Œéœ€ç”¨æŠ—çœŸèŒè¯ã€‚"
    },
    {
        "title": "æ‹³å‡»æ‰‹çš„è§†åŠ›å±æœº",
        "desc": "æ‹³å‡»æ‰‹å³çœ¼è¢«æ‹³å¥—å‡»ä¸­ã€‚çœ¼éƒ¨ç–¼ç—›ï¼Œè§†åŠ›æ¨¡ç³Šã€‚è£‚éš™ç¯æ£€æŸ¥å‘ç°å‰æˆ¿ä¸‹æ–¹æœ‰çº¢è‰²æ¶²å¹³ï¼Œç³å­”å‘ˆDå½¢ã€‚",
        "options": ["ç»“è†œä¸‹å‡ºè¡€", "å‰æˆ¿ç§¯è¡€+è™¹è†œæ ¹éƒ¨ç¦»æ–­", "è§†ç½‘è†œéœ‡è¡", "æ™¶çŠ¶ä½“å…¨è„±ä½"],
        "answer": "å‰æˆ¿ç§¯è¡€+è™¹è†œæ ¹éƒ¨ç¦»æ–­",
        "explanation": "å…³é”®è¯åŒ¹é…ï¼šé’æŒ«ä¼¤ + å‰æˆ¿æ¶²å¹³ï¼ˆå‰æˆ¿ç§¯è¡€ï¼‰ + ç³å­”Då½¢ï¼ˆè™¹è†œæ ¹éƒ¨ç¦»æ–­ï¼‰ã€‚éœ€åŠå§ä½ä¼‘æ¯ï¼Œé˜²æ­¢ç»§å‘æ€§é’å…‰çœ¼ã€‚"
    }
]

# ==========================================
# 3. ä¾§è¾¹æ å¯¼èˆª
# ==========================================
with st.sidebar:
    st.image("https://img.icons8.com/color/96/000000/eye.png", width=80)
    st.title("ğŸ‘ï¸ OphthLogic")
    st.caption("ä»æœºåˆ¶æ¨å¯¼ä¸´åºŠï¼Œæ‹’ç»æ­»è®°ç¡¬èƒŒ")
    
    menu = st.radio(
        "å¤ä¹ æ¨¡å—",
        ["ğŸ  é¦–é¡µ (Dashboard)", "ğŸ§¬ æ¨¡å—ä¸€ï¼šè§£å‰–ä¸åŸºç¡€", "ğŸ¥ æ¨¡å—äºŒï¼šä¸´åºŠæ ¸å¿ƒ", "ğŸ› ï¸ æ¨¡å—ä¸‰ï¼šé«˜åˆ†å·¥å…·ç®±", "âš”ï¸ æ¨¡å—å››ï¼šå®æˆ˜æ¼”ç»ƒ"]
    )
    
    st.divider()
    st.info("ğŸ’¡ è¿›åº¦æç¤ºï¼š\nå½“å‰é‡ç‚¹å¤ä¹ ï¼š**çœ¼çƒé’æŒ«ä¼¤ä¸å……è¡€é‰´åˆ«**")

# ==========================================
# 4. ä¸»é¡µé¢é€»è¾‘
# ==========================================

# --- é¦–é¡µ ---
if "é¦–é¡µ" in menu:
    st.title("æ¬¢è¿æ¥åˆ°çœ¼ç§‘é«˜åˆ†é€»è¾‘ç«™")
    st.markdown("### *Slogan: Logic beats Rote Memory.*")
    
    col1, col2 = st.columns([2, 1])
    
    with col1:
        st.markdown('<div class="highlight">ğŸ“š <b>ä»Šæ—¥å¤ä¹ é‡ç‚¹ï¼š</b><br>1. ç»“è†œå……è¡€ vs ç«çŠ¶å……è¡€çš„è§£å‰–æœºåˆ¶ã€‚<br>2. çœ¼çƒé’æŒ«ä¼¤çš„â€œéš”å±±æ‰“ç‰›â€æ•ˆåº”ã€‚<br>3. è§’è†œç‚çš„ç—…åŸä½“åˆ¤æ–­ã€‚</div>', unsafe_allow_html=True)
        
    with col2:
        st.markdown('<div class="mnemonic">ğŸ”” <b>æ¯æ—¥ä¸€è®°ï¼š</b><br>{}</div>'.format(random.choice(mnemonics)), unsafe_allow_html=True)

    st.subheader("å¿«é€Ÿå…¥å£")
    c1, c2, c3 = st.columns(3)
    with c1:
        if st.button("ğŸ”´ çº¢çœ¼ç—…é‰´åˆ«"): st.toast("è¯·è·³è½¬è‡³æ¨¡å—ä¸€")
    with c2:
        if st.button("ğŸ’¥ çœ¼å¤–ä¼¤æ€¥æ•‘"): st.toast("è¯·è·³è½¬è‡³æ¨¡å—äºŒ")
    with c3:
        if st.button("ğŸ“ è€ƒå‰åˆ·é¢˜"): st.toast("è¯·è·³è½¬è‡³æ¨¡å—å››")

# --- æ¨¡å—ä¸€ï¼šè§£å‰–ä¸åŸºç¡€ ---
elif "æ¨¡å—ä¸€" in menu:
    st.title("ğŸ§¬ è§£å‰–ä¸åŸºç¡€æœºåˆ¶")
    st.write("ç†è§£äº†è§£å‰–ï¼Œä¸´åºŠè¡¨ç°å°±æ˜¯é¡ºç†æˆç« çš„äº‹ã€‚")
    
    tab1, tab2 = st.tabs(["ğŸ”´ çº¢çœ¼é‰´åˆ«æœºåˆ¶", "ğŸ’§ æ³ªè†œä¸å¹²çœ¼"])
    
    with tab1:
        st.subheader("ä¸ºä»€ä¹ˆçœ¼ç›ä¼šçº¢ï¼Ÿ")
        st.markdown("ä¸è¦æ­»è®°è¡¨æ ¼ï¼Œçœ‹è¡€ç®¡èµ°è¡Œï¼")
        st.info("ğŸ’¡ **é€»è¾‘æ¨å¯¼**ï¼šç»“è†œè¡€ç®¡ä½ç½®æµ…ï¼Œæ‰€ä»¥é²œçº¢ã€æ¨å¾—åŠ¨ï¼›ç«çŠ¶è¡€ç®¡ä½ç½®æ·±ï¼ˆåœ¨å·©è†œé‡Œï¼‰ï¼Œæ‰€ä»¥ç´«çº¢ã€æ¨ä¸åŠ¨ã€‚")
        
        # äº¤äº’å¼å›¾ç‰‡æ¨¡æ‹Ÿï¼ˆè¿™é‡Œç”¨æ–‡å­—ä»£æ›¿å›¾ç‰‡ï¼‰
        c1, c2 = st.columns(2)
        with c1:
            st.error("#### ç»“è†œå……è¡€ (æµ…)")
            st.markdown("- æ¥æºï¼š**ç»“è†œååŠ¨è„‰**\n- æ»´è‚¾ä¸Šè…ºç´ ï¼š**ç«‹å³å˜ç™½** (è¡€ç®¡æœ‰å¹³æ»‘è‚Œ)")
        with c2:
            st.warning("#### ç«çŠ¶å……è¡€ (æ·±)")
            st.markdown("- æ¥æºï¼š**ç«çŠ¶å‰åŠ¨è„‰**\n- æ»´è‚¾ä¸Šè…ºç´ ï¼š**æ— å˜åŒ–**")

# --- æ¨¡å—äºŒï¼šä¸´åºŠæ ¸å¿ƒ ---
elif "æ¨¡å—äºŒ" in menu:
    st.title("ğŸ¥ ä¸´åºŠæ ¸å¿ƒç–¾ç—…")
    
    disease_tab = st.selectbox("é€‰æ‹©ç–¾ç—…ç« èŠ‚", ["çœ¼å¤–ä¼¤ (Trauma)", "è§’è†œç—… (Cornea)", "æ™¶çŠ¶ä½“ (Lens)"])
    
    if disease_tab == "çœ¼å¤–ä¼¤ (Trauma)":
        st.header("çœ¼çƒé’æŒ«ä¼¤")
        st.markdown("æœºåˆ¶ï¼š**éš”å±±æ‰“ç‰›**ã€‚çœ¼çƒå®Œæ•´ï¼Œä½†å†…éƒ¨ç»“æ„å—æŸã€‚")
        
        st.markdown("### ğŸš‘ æŸä¼¤éƒ¨ä½ä¸è¡¨ç°")
        
        col1, col2, col3 = st.columns(3)
        with col1:
            st.metric(label="å‰æˆ¿", value="å‰æˆ¿ç§¯è¡€", delta="Hyphema")
            st.caption("åˆ†çº§çœ‹é«˜åº¦ã€‚å¹¶å‘ç—‡ï¼šç»§å‘é’å…‰çœ¼ã€è§’è†œè¡€æŸ“ã€‚")
        with col2:
            st.metric(label="è™¹è†œ", value="æ ¹éƒ¨ç¦»æ–­", delta="Då½¢ç³å­”")
            st.caption("ç³å­”å˜å½¢ï¼Œéœ€æ‰‹æœ¯ä¿®å¤ã€‚")
        with col3:
            st.metric(label="è§†ç½‘è†œ", value="è§†ç½‘è†œéœ‡è¡", delta="Berlinæ°´è‚¿")
            st.caption("é»„æ–‘æ¨±æ¡ƒçº¢æ–‘ï¼ˆéœ€é‰´åˆ«CRAOï¼‰ã€‚å¯è‡ªæ„ˆã€‚")

    elif disease_tab == "è§’è†œç—… (Cornea)":
        st.warning("å†…å®¹æ­£åœ¨å»ºè®¾ä¸­... (å¯æ ¹æ®æ–‡æ¡£`è§’è†œäº”å±‚æ¥¼`éƒ¨åˆ†è¡¥å……)")

# --- æ¨¡å—ä¸‰ï¼šé«˜åˆ†å·¥å…·ç®± ---
elif "æ¨¡å—ä¸‰" in menu:
    st.title("ğŸ› ï¸ é«˜åˆ†å·¥å…·ç®±")
    st.write("è€ƒå‰çªå‡»ä¸“ç”¨ï¼ŒåŒ…å«é»„é‡‘è¡¨æ ¼å’Œé™·é˜±æç¤ºã€‚")
    
    st.subheader("ğŸ† é»„é‡‘é‰´åˆ«è¡¨ï¼šç»“è†œ vs ç«çŠ¶å……è¡€")
    
    # äº¤äº’åŠŸèƒ½ï¼šæ­»è®°ç¡¬èƒŒæ¨¡å¼
    blind_mode = st.toggle("ğŸ›¡ï¸ å¼€å¯â€œæ­»è®°ç¡¬èƒŒâ€é®æŒ¡æ¨¡å¼ (Blind Mode)")
    
    df = pd.DataFrame(red_eye_data)
    
    if blind_mode:
        # é®æŒ¡å…³é”®åˆ—
        st.caption("å°è¯•å›å¿†è¢«é®æŒ¡çš„å†…å®¹...")
        st.dataframe(df[["é‰´åˆ«ç‚¹"]], use_container_width=True, height=320)
    else:
        st.dataframe(df, use_container_width=True, height=320)
        
    st.markdown("---")
    st.subheader("ğŸ’¡ è€ƒè¯•é™·é˜± (Pitfalls)")
    st.error("âŒ **æ··åˆå……è¡€**ï¼šä¸¥é‡çš„è§’è†œç‚æˆ–å…¨è‘¡è„è†œç‚æ—¶ï¼Œä¸¤è€…åŒæ—¶å­˜åœ¨ï¼Œä¸è¦åªçœ‹ä¸€ä¸ªï¼")
    st.error("âŒ **è§†ç½‘è†œéœ‡è¡ vs åŠ¨è„‰é˜»å¡**ï¼šéƒ½æœ‰é»„æ–‘æ¨±æ¡ƒçº¢ï¼Œä½†å‰è€…æœ‰å¤–ä¼¤å²ï¼Œåè€…å¤šä¸ºè€å¹´äººæ— ç—›æ€§è§†åŠ›ä¸‹é™ã€‚")

# --- æ¨¡å—å››ï¼šå®æˆ˜æ¼”ç»ƒ ---
elif "æ¨¡å—å››" in menu:
    st.title("âš”ï¸ å®æˆ˜æ¼”ç»ƒ (Simulation)")
    
    st.write("åŸºäºçœŸå®ç—…ä¾‹çš„é€»è¾‘æ¨å¯¼è®­ç»ƒã€‚")
    
    for i, case in enumerate(cases):
        with st.expander(f"ç—…ä¾‹ {i+1}: {case['title']}", expanded=True):
            st.markdown(f"**ç—…å²**ï¼š{case['desc']}")
            
            # ä½¿ç”¨ session_state é˜²æ­¢é‡è½½æ—¶é‡ç½®é€‰é¡¹
            key = f"q_{i}"
            user_choice = st.radio("è¯·é€‰æ‹©æœ€å¯èƒ½çš„è¯Šæ–­ï¼š", case['options'], key=key)
            
            if st.button(f"æäº¤ç­”æ¡ˆ (ç—…ä¾‹ {i+1})"):
                if user_choice == case['answer']:
                    st.success(f"âœ… æ­£ç¡®ï¼\n\n**è§£æ**ï¼š{case['explanation']}")
                    st.balloons()
                else:
                    st.error(f"âŒ é”™è¯¯ã€‚æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š**{case['answer']}**")
                    st.info(f"**è§£æ**ï¼š{case['explanation']}")

# ==========================================
# åº•éƒ¨Footer
# ==========================================
st.markdown("---")
st.caption("Developed with â¤ï¸ based on Uploaded Ophthalmology Notes | Â© 2024 OphthLogic")