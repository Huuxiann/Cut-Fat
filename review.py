import streamlit as st
import pandas as pd
import random

# ==========================================
# 1. é¡µé¢é…ç½®ä¸æ²‰æµ¸å¼æ ·å¼
# ==========================================
st.set_page_config(
    page_title="çœ¼ç§‘å…¨ä¹¦å¤ä¹ ç«™ (OphthPro)",
    page_icon="ğŸ‘ï¸",
    layout="wide",
    initial_sidebar_state="expanded"
)

# æ³¨å…¥CSSï¼šæ‰“é€ ä¸“ä¸šå¤ä¹ ä½“éªŒï¼ŒåŒºåˆ†ä¸åŒç±»å‹çš„çŸ¥è¯†ç‚¹
st.markdown("""
<style>
    .stApp { font-family: 'Microsoft YaHei', sans-serif; }
    
    /* æ ¸å¿ƒæ¦‚å¿µ (è“è‰²) - ç”¨äºå®šä¹‰å’ŒåŸºç¡€ */
    .concept-box { 
        background-color: #e3f2fd; 
        padding: 15px; 
        border-radius: 8px; 
        border-left: 5px solid #2196f3; 
        margin-bottom: 15px; 
        color: #0d47a1;
    }
    
    /* æœºåˆ¶è§£æ (ç´«è‰²) - ç”¨äºè§£é‡Šä¸ºä»€ä¹ˆ */
    .mech-box { 
        background-color: #f3e5f5; 
        padding: 15px; 
        border-radius: 8px; 
        border-left: 5px solid #ab47bc; 
        margin-bottom: 15px;
        color: #4a148c;
    }
    
    /* è€ƒè¯•é™·é˜± (çº¢è‰²) - ç”¨äºæ˜“é”™ç‚¹ */
    .pitfall-box { 
        background-color: #ffebee; 
        padding: 15px; 
        border-radius: 8px; 
        border-left: 5px solid #ef5350; 
        margin-bottom: 15px;
        color: #c62828;
    }
    
    /* è®°å¿†å£è¯€ (é»„è‰²) - ç”¨äºèƒŒè¯µ */
    .mnemonic-box { 
        background-color: #fffde7; 
        padding: 15px; 
        border-radius: 8px; 
        border: 2px dashed #fbc02d; 
        font-style: italic; 
        margin-bottom: 15px;
        color: #f57f17;
    }
    
    /* é«˜åˆ†Tips (ç»¿è‰²) - ç”¨äºåŠ åˆ†é¡¹ */
    .tip-box {
        background-color: #e8f5e9;
        padding: 15px;
        border-radius: 8px;
        border-left: 5px solid #66bb6a;
        margin-bottom: 15px;
        color: #1b5e20;
    }

    h1, h2, h3 { color: #2c3e50; font-weight: 600; }
    .stDataFrame { border: 1px solid #eee; border-radius: 5px; }
</style>
""", unsafe_allow_html=True)

# ==========================================
# 2. å…¨é‡çŸ¥è¯†åº“ (Knowledge Base)
#    è¿™é‡ŒåŒ…å«äº†æ–‡æ¡£ä¸­æ‰€æœ‰çš„æ–‡å­—ã€è¡¨æ ¼å’Œé€»è¾‘
# ==========================================

KB = {
    # --- æ¨¡å—1ï¼šæ³ªæ¶² ---
    "tear_layers": {
        "cols": ["å±‚æ¬¡", "åç§°", "ä¸»è¦æ¥æº", "ä¸»è¦åŠŸèƒ½", "å¼‚å¸¸è¡¨ç° (è€ƒç‚¹)"],
        "data": [
            ["å¤–å±‚", "è„‚è´¨å±‚", "ç‘æ¿è…º (MGD)", "é˜²è’¸å‘ã€å¢åŠ è¡¨é¢å¼ åŠ›", "è’¸å‘è¿‡å¼ºå‹å¹²çœ¼ï¼ŒBUTç¼©çŸ­"],
            ["ä¸­å±‚", "æ°´æ¶²å±‚", "ä¸»/å‰¯æ³ªè…º", "ä¾›æ°§ã€è¥å…»ã€æŠ—èŒã€å†²æ´—", "æ°´æ¶²ç¼ºä¹å‹å¹²çœ¼ (Sjogren)"],
            ["å†…å±‚", "é»è›‹ç™½å±‚", "ç»“è†œæ¯çŠ¶ç»†èƒ", "äº²æ°´ç•Œé¢ï¼ˆåŒé¢èƒ¶ï¼‰", "æ³ªæ¶²æ— æ³•é“ºå±•ï¼Œå½¢æˆå¹²æ–‘"]
        ]
    },
    "dry_eye_tests": {
        "cols": ["æ£€æŸ¥é¡¹ç›®", "æ­£å¸¸å€¼", "ä¸´åºŠæ„ä¹‰"],
        "data": [
            ["BUT (æ³ªè†œç ´è£‚æ—¶é—´)", "> 10ç§’", "åæ˜ ç¨³å®šæ€§ (æ²¹å±‚/é»è›‹ç™½å±‚)ã€‚MGDå…¸å‹è¡¨ç°ã€‚"],
            ["Schirmer I è¯•éªŒ", "> 10mm/5min", "åæ˜ æ€»åˆ†æ³Œé‡ã€‚Sjogrenç»¼åˆå¾å…¸å‹è¡¨ç°ã€‚"],
            ["è§å…‰ç´ æŸ“è‰² (FL)", "é˜´æ€§", "é˜³æ€§æç¤ºè§’è†œä¸Šçš®ç¼ºæŸ (PEE)ã€‚"]
        ]
    },

    # --- æ¨¡å—2ï¼šè§’è†œ ---
    "cornea_layers": {
        "cols": ["å±‚æ¬¡", "åç§°", "å†ç”Ÿèƒ½åŠ› (æ ¸å¿ƒé‰´åˆ«)", "ç‰¹ç‚¹"],
        "data": [
            ["1", "ä¸Šçš®ç»†èƒå±‚", "âœ… æå¼º (24-48h)", "å¯Œå«ç¥ç»ï¼Œç—›è§‰æ•é”ï¼›ä¸ç•™ç—•"],
            ["2", "å‰å¼¹åŠ›å±‚", "âŒ ä¸å¯å†ç”Ÿ", "æŸä¼¤åç•™äº‘ç¿³/æ–‘ç¿³"],
            ["3", "åŸºè´¨å±‚", "âŒ ä¸å¯å†ç”Ÿ", "æœ€åš(90%)ï¼Œè§„åˆ™æ’åˆ—æ˜¯é€æ˜åŸºç¡€"],
            ["4", "åå¼¹åŠ›å±‚", "âœ… å¯å†ç”Ÿ", "åšéŸ§ï¼Œè€ä¾µèš€ (Descemetocele)"],
            ["5", "å†…çš®ç»†èƒå±‚", "âŒ ä¸å¯å†ç”Ÿ", "æ³µåŠŸèƒ½ç»´æŒè„±æ°´ï¼›<500æ—¶å¤±ä»£å¿æ°´è‚¿"]
        ]
    },

    # --- æ¨¡å—3ï¼šçº¢çœ¼ ---
    "red_eye": {
        "cols": ["é‰´åˆ«ç‚¹", "ç»“è†œå……è¡€ (Conjunctival)", "ç«çŠ¶å……è¡€ (Ciliary)"],
        "data": [
            ["è¡€ç®¡æ¥æº", "ç»“è†œååŠ¨è„‰ (æµ…)", "ç«çŠ¶å‰åŠ¨è„‰ (æ·±)"],
            ["å¤–è§‚", "é²œçº¢è‰²ï¼Œæ ‘æç½‘çŠ¶", "ç´«çº¢è‰²ï¼Œæ¯›åˆ·/æ”¾å°„çŠ¶"],
            ["éƒ¨ä½", "ç©¹éš†éƒ¨æ˜æ˜¾", "è§’è†œç¼˜æ˜æ˜¾"],
            ["ç§»åŠ¨æ€§", "æ¨å¾—åŠ¨", "æ¨ä¸åŠ¨"],
            ["è‚¾ä¸Šè…ºç´ ", "æ•æ„Ÿ (å˜ç™½)", "ä¸æ•æ„Ÿ"],
            ["ä¼´éšç—‡çŠ¶", "åˆ†æ³Œç‰©å¤šï¼Œè§†åŠ›å¥½", "ç—›ã€ç•å…‰ã€æµæ³ªï¼Œè§†åŠ›é™"],
            ["å¸¸è§ç—…", "ç»“è†œç‚", "è§’è†œç‚ã€è™¹ç«ç‚ã€é’å…‰çœ¼"]
        ]
    },

    # --- æ¨¡å—4ï¼šè§’è†œç‚ ---
    "keratitis": {
        "cols": ["é‰´åˆ«ç‚¹", "ç»†èŒæ€§", "çœŸèŒæ€§", "ç—…æ¯’æ€§ (HSV)"],
        "data": [
            ["è¯±å› ", "å¤–ä¼¤ã€æˆ´é•œã€å€’ç«", "æ¤ç‰©å¤–ä¼¤ (ç‰ç±³å¶/æ ‘æ)", "æ„Ÿå†’/å‘çƒ­å¤å‘"],
            ["èµ·ç—…", "æ€¥ (24hå‰§å˜)", "ç¼“ (äºšæ€¥æ€§)", "åå¤å‘ä½œ"],
            ["ç—‡çŠ¶", "å‰§ç—›ã€è„“å¤š", "ç—‡å¾åˆ†ç¦» (çœ‹ç€é‡ç–¼å¾—è½»)", "ç—›æ„Ÿè½» (çŸ¥è§‰å‡é€€)"],
            ["ç‰¹å¾", "æ¹¿æ¶¦åæ­»ã€å‰æˆ¿ç§¯è„“", "ç¾½æ¯›çŠ¶ã€å«æ˜Ÿç¶ã€èŒä¸è‹”è¢«", "æ ‘æçŠ¶ã€åœ°å›¾çŠ¶"],
            ["æ²»ç–—", "å·¦æ°§/å¦¥å¸ƒéœ‰ç´  (é¢‘ç¹)", "çº³ä»–éœ‰ç´  (å¿Œæ¿€ç´ )", "æ›´æ˜”æ´›éŸ¦ (å¿Œæ¿€ç´ )"]
        ]
    },

    # --- æ¨¡å—5ï¼šç™½å†…éšœ ---
    "cataract_stages": {
        "cols": ["åˆ†æœŸ", "å…³é”®ç‰¹å¾", "å¹¶å‘ç—‡/è€ƒç‚¹"],
        "data": [
            ["åˆå‘æœŸ", "æ¥”å½¢æ··æµŠ", "è§†åŠ›ä¸€èˆ¬ä¸å—å½±å“"],
            ["è†¨èƒ€æœŸ", "æ™¶ä½“è‚¿èƒ€ã€è™¹è†œå‰ç§»", "è¯±å‘ã€æ€¥æ€§é—­è§’å‹é’å…‰çœ¼ã€‘"],
            ["æˆç†ŸæœŸ", "å®Œå…¨æ··æµŠã€çœ¼åº•çœ‹ä¸è§", "æ‰‹æœ¯æ—¶æœº"],
            ["è¿‡ç†ŸæœŸ", "çš®è´¨æ¶²åŒ–ã€æ ¸ä¸‹æ²‰", "è¯±å‘ã€æ™¶çŠ¶ä½“æº¶è§£æ€§é’å…‰çœ¼ã€‘"]
        ]
    },
    "lens_dislocation": {
        "cols": ["ç–¾ç—…", "é—ä¼ ", "è„±ä½æ–¹å‘", "ä½“å‹ç‰¹å¾"],
        "data": [
            ["Marfanç»¼åˆå¾", "å¸¸æ˜¾ (AD)", "é¢ä¸Šæ–¹ (Up-Out)", "é«˜ç˜¦ã€èœ˜è››æŒ‡ã€ä¸»åŠ¨è„‰å¤¹å±‚"],
            ["åŒå‹åŠèƒ±æ°¨é…¸", "å¸¸éš (AR)", "é¼»ä¸‹æ–¹ (Down-In)", "éª¨è´¨ç–æ¾ã€æ™ºåŠ›ä½"],
            ["Weill-Marchesani", "å¸¸éš (AR)", "ä¸‹æ–¹", "èº«æçŸ®å°ã€çŸ­æŒ‡"]
        ]
    },

    # --- æ¨¡å—6ï¼šé’å…‰çœ¼ ---
    "glaucoma_type": {
        "cols": ["é‰´åˆ«ç‚¹", "é—­è§’å‹ (PACG)", "å¼€è§’å‹ (POAG)"],
        "data": [
            ["æœºåˆ¶", "æˆ¿è§’å…³é—­ (é—¨å…³äº†)", "å°æ¢ç½‘å µå¡ (ä¸‹æ°´é“å µäº†)"],
            ["æˆ¿è§’", "çª„/é—­", "å®½/å¼€"],
            ["èµ·ç—…", "æ€¥éª¤ (å¤´ç—›å‘•å)", "éšåŒ¿ (è§†åŠ›æ€æ‰‹)"],
            ["ä½“å¾", "æ··åˆå……è¡€ã€è§’è†œé›¾çŠ¶", "C/Dæ‰©å¤§ã€è§†é‡ç¼ºæŸ"],
            ["æ²»ç–—", "æ¿€å…‰å‘¨åˆ‡/æ™¶ä½“æ‘˜é™¤", "è¯ç‰©/å°æ¢åˆ‡é™¤"]
        ]
    },
    "optic_nerve": {
        "cols": ["æŒ‡æ ‡", "é’å…‰çœ¼ç‰¹å¾"],
        "data": [
            ["C/Dæ¯”å€¼", "> 0.6 æˆ– åŒçœ¼å·® > 0.2"],
            ["è§†æ¯å½¢æ€", "å‚ç›´æ¤­åœ†æ‰©å¤§ (ç«–ç€é•¿)"],
            ["ç›˜æ²¿", "ISNTæ³•åˆ™ä¸§å¤± (å˜çª„)"],
            ["è¡€ç®¡", "é¼»ä¾§ç§»ä½ã€åˆºåˆ€å¾ (Bayoneting)"],
            ["è§†ç›˜å‘¨å›´", "Î²åŒºèç¼©ã€ç›˜çŠ¶å‡ºè¡€"]
        ]
    },

    # --- æ¨¡å—7ï¼šè‘¡è„è†œç‚ ---
    "uveitis_class": {
        "cols": ["ç±»å‹", "ä¸»æˆ˜åœº", "ç‰¹å¾ä½“å¾"],
        "data": [
            ["å‰è‘¡è„è†œç‚", "è™¹è†œ/ç«çŠ¶ä½“", "KPã€æˆ¿æ°´é—ªè¾‰ã€ç³å­”ç¼©å°"],
            ["ä¸­é—´è‘¡è„è†œç‚", "ç»ç’ƒä½“", "é›ªçƒçŠ¶æ··æµŠ (Snowballs)"],
            ["åè‘¡è„è†œç‚", "è„‰ç»œè†œ/è§†ç½‘è†œ", "çœ¼åº•ç—…ç¶ã€è§†åŠ›ä¸‹é™"]
        ]
    },
    "red_eye_3_demons": {
        "cols": ["é‰´åˆ«ç‚¹", "æ€¥æ€§è™¹ç«ç‚", "æ€¥æ€§ç»“è†œç‚", "æ€¥æ€§é—­è§’é’å…‰çœ¼"],
        "data": [
            ["å……è¡€", "ç«çŠ¶ (ç´«)", "ç»“è†œ (é²œ)", "æ··åˆ"],
            ["ç³å­”", "ç¼©å° (æ¢…èŠ±ç“£)", "æ­£å¸¸", "æ•£å¤§ (ç«–æ¤­åœ†)"],
            ["è§’è†œ", "é€æ˜+KP", "é€æ˜", "é›¾çŠ¶æ°´è‚¿"],
            ["å‰æˆ¿", "é—ªè¾‰", "æ­£å¸¸", "ææµ…"],
            ["çœ¼å‹", "æ­£å¸¸/åä½", "æ­£å¸¸", "æé«˜"]
        ]
    },

    # --- æ¨¡å—8ï¼šçœ¼å¤–ä¼¤ ---
    "trauma_contusion": {
        "cols": ["æŸä¼¤éƒ¨ä½", "åç§°", "è¡¨ç°"],
        "data": [
            ["å‰æˆ¿", "å‰æˆ¿ç§¯è¡€", "ç»§å‘é’å…‰çœ¼ã€è§’è†œè¡€æŸ“"],
            ["è™¹è†œ", "æ ¹éƒ¨ç¦»æ–­", "Då½¢ç³å­”"],
            ["æ™¶çŠ¶ä½“", "è„±ä½", "è™¹è†œéœ‡é¢¤"],
            ["è§†ç½‘è†œ", "è§†ç½‘è†œéœ‡è¡", "Berlinæ°´è‚¿ (æ¨±æ¡ƒçº¢)"]
        ]
    },

    # --- å£è¯€åº“ ---
    "mnemonics": [
        "ã€ç»“è†œå……è¡€ã€‘ç»“è†œé²œçº¢ç©¹éš†èµ·ï¼Œæ¨ä¹‹èƒ½åŠ¨è‚¾ä¸Šæ¶ˆã€‚",
        "ã€ç«çŠ¶å……è¡€ã€‘ç«çŠ¶ç´«çº¢è§’è†œç»•ï¼Œæ¨ä¹‹ä¸åŠ¨éš¾æ¶ˆé€€ã€‚",
        "ã€æ³ªè†œã€‘å¤–æ²¹ä¸­æ°´å†…é»è†œï¼Œæ²¹é˜²è’¸å‘æ°´ä¾›å…»ã€‚",
        "ã€è§’è†œã€‘ä¸Šçš®å†ç”Ÿä¸ç•™ç—•ï¼Œå‰å¼¹åŸºè´¨ç•™ç–¤ç—•ã€‚",
        "ã€è§’è†œç‚ã€‘ç»†èŒæ€¥è„“æ€§å¤šï¼ŒçœŸèŒç¼“ç¾½æ¯›æ‰©ï¼Œç—…æ¯’å¤æ ‘æé•¿ã€‚",
        "ã€è„±ä½ã€‘Marfan é«˜å¯Œå¸…å¾€ä¸Šçœ‹ (å¤–ä¸Š)ï¼›åŒå‹ å‚»ç™½ç”œå¾€ä¸‹çœ‹ (å†…ä¸‹)ã€‚",
        "ã€è‘¡è„è†œç‚ã€‘è…°ç–¼B27ç”·å‰æˆ¿ï¼Œå£è…”æºƒç–¡ç™½å¡å¿™ï¼Œæ™šéœç™½å‘VKHã€‚",
        "ã€é’å…‰çœ¼è§†é‡ã€‘æ—©æœŸæ—ä¸­å¿ƒï¼Œé¼»ä¾§é˜¶æ¢¯è—ï¼›ä¸­æœŸè¿æˆå¼“ï¼Œæ™šæœŸç®¡çŠ¶æœ›ã€‚"
    ]
}

# ==========================================
# 3. è¾…åŠ©ç»„ä»¶å‡½æ•°
# ==========================================

def render_table(key, blind_mode=False):
    """æ¸²æŸ“è¡¨æ ¼ï¼Œæ”¯æŒé®æŒ¡æ¨¡å¼"""
    if key in KB:
        df = pd.DataFrame(KB[key]["data"], columns=KB[key]["cols"])
        if blind_mode:
            st.dataframe(df.iloc[:, [0]], use_container_width=True)
            st.info("ğŸ™ˆ é®æŒ¡æ¨¡å¼å·²å¼€å¯ï¼Œè¯·å°è¯•å›å¿†å…¶ä»–åˆ—çš„å†…å®¹...")
        else:
            st.dataframe(df, use_container_width=True)

def box(type, title, text):
    """æ¸²æŸ“å½©è‰²æ¡†"""
    if type == "concept": st.markdown(f'<div class="concept-box">ğŸ“˜ <b>{title}</b><br>{text}</div>', unsafe_allow_html=True)
    elif type == "mech": st.markdown(f'<div class="mech-box">âš™ï¸ <b>{title}</b><br>{text}</div>', unsafe_allow_html=True)
    elif type == "pitfall": st.markdown(f'<div class="pitfall-box">âŒ <b>{title}</b><br>{text}</div>', unsafe_allow_html=True)
    elif type == "mnemonic": st.markdown(f'<div class="mnemonic-box">ğŸ”” <b>å£è¯€ï¼š</b>{text}</div>', unsafe_allow_html=True)
    elif type == "tip": st.markdown(f'<div class="tip-box">ğŸ’¡ <b>{title}</b><br>{text}</div>', unsafe_allow_html=True)

# ==========================================
# 4. ä¾§è¾¹æ èœå• (13ä¸ªæ¨¡å—)
# ==========================================
with st.sidebar:
    st.title("ğŸ‘ï¸ OphthPro")
    st.caption("å…¨é‡å†…å®¹æ³¨å…¥ç‰ˆ")
    st.divider()
    
    page = st.radio("å¤ä¹ å¯¼èˆª", [
        "0. ğŸ  é¦–é¡µ (Dashboard)",
        "1. ğŸ’§ è§£å‰–ï¼šæ³ªæ¶²ä¸å¹²çœ¼",
        "2. ğŸ‘ï¸ è§£å‰–ï¼šè§’è†œäº”å±‚æ¥¼",
        "3. ğŸ”´ é‰´åˆ«ï¼šçº¢çœ¼ä¸‰å¤§é­”å¤´",
        "4. ğŸ¦  ç–¾ç—…ï¼šè§’è†œç‚ä½“ç³»",
        "5. â˜ï¸ ç–¾ç—…ï¼šç™½å†…éšœå…¨è§£æ",
        "6. ğŸŒ‘ ç–¾ç—…ï¼šé’å…‰çœ¼æœºåˆ¶",
        "7. ğŸ”¥ ç–¾ç—…ï¼šè‘¡è„è†œç‚",
        "8. ğŸš‘ æ€¥è¯Šï¼šçœ¼å¤–ä¼¤å¤„ç†",
        "9. ğŸ©º æ‹“å±•ï¼šè§†ç½‘è†œä¸çœ¼åº•",
        "10. ğŸ’Š æ²»ç–—ï¼šæ ¸å¿ƒè¯ç‰©",
        "11. âš”ï¸ å®æˆ˜ï¼šç—…ä¾‹æ¨¡æ‹Ÿ",
        "12. ğŸ’ å®å…¸ï¼šå£è¯€æ±‡æ€»"
    ])
    
    st.divider()
    st.info("ğŸ’¡ **æ¯æ—¥å¤ä¹ **ï¼š\n" + random.choice(KB["mnemonics"]))

# ==========================================
# 5. é¡µé¢é€»è¾‘å®ç°
# ==========================================

# --- é¦–é¡µ ---
if page.startswith("0"):
    st.title("çœ¼ç§‘å…¨ä¹¦å¤ä¹ ç«™")
    st.markdown("### *Logic Beats Rote Memory.*")
    st.write("æ¬¢è¿å›æ¥ï¼æœ¬ç³»ç»Ÿå·²æ”¶å½•æ–‡æ¡£ä¸­æ‰€æœ‰å…³äº**æœºåˆ¶ã€é‰´åˆ«ã€ç—…ç†åŠæ²»ç–—**çš„å†…å®¹ã€‚")
    
    c1, c2 = st.columns(2)
    with c1:
        box("concept", "å¤ä¹ è·¯å¾„", "è§£å‰– -> æœºåˆ¶ -> é‰´åˆ« -> ç–¾ç—… -> æ€¥æ•‘ -> å®æˆ˜")
    with c2:
        box("tip", "é«˜åˆ†ç­–ç•¥", "é‡åˆ°çº¢çœ¼å…ˆçœ‹å……è¡€æ€§è´¨ï¼›é‡åˆ°è§†åŠ›ä¸‹é™å…ˆæŸ¥çœ¼åº•å’Œæ™¶ä½“ã€‚")

# --- æ³ªæ¶² ---
elif page.startswith("1"):
    st.title("ğŸ’§ æ¨¡å—ä¸€ï¼šæ³ªæ¶²ä¸å¹²çœ¼")
    
    tab1, tab2 = st.tabs(["æ³ªæ¶²ç³»ç»Ÿ", "å¹²çœ¼åˆ†ç±»"])
    
    with tab1:
        st.subheader("1. æ³ªé“è§£å‰–æµå‘")
        st.code("ç‚¹ -> å° -> æ€» -> å›Š -> é¼» -> ä¸‹", language='text')
        box("pitfall", "è§£å‰–é™·é˜±", "é¼»æ³ªç®¡å¼€å£äº**ä¸‹é¼»é“**ï¼ˆHasnerç“£ï¼‰ï¼æ–°ç”Ÿå„¿æ³ªå›Šç‚å°±æ˜¯å› ä¸ºè¿™ä¸ªç“£è†œæ²¡ç ´ã€‚")
        
        st.subheader("2. æ³ªè†œä¸‰å±‚ç»“æ„")
        render_table("tear_layers")
        box("mech", "é»è›‹ç™½çš„ä½œç”¨", "ç–æ°´çš„è§’è†œä¸Šçš®æŠ“ä¸ä½æ°´ï¼Œå¿…é¡»é é»è›‹ç™½å½“'åŒé¢èƒ¶'ï¼Œä¸€ç«¯æŠ“ä¸Šçš®ï¼Œä¸€ç«¯æŠ“æ°´ã€‚")

    with tab2:
        st.subheader("å¹²çœ¼ç—‡ä¸¤å¤§ç±» (ADDE vs EDE)")
        st.markdown("""
        * **æ°´æ¶²ç¼ºä¹å‹ (ADDE)**ï¼šæ³ªè…ºåäº†ã€‚å¦‚ Sjogrenç»¼åˆå¾ã€ç±»é£æ¹¿ã€‚
        * **è’¸å‘è¿‡å¼ºå‹ (EDE)**ï¼šæ²¹å°‘äº†ã€‚å¦‚ ç‘æ¿è…ºåŠŸèƒ½éšœç¢ (MGD)ã€è§†é¢‘ç»ˆç«¯ç»¼åˆå¾ã€‚
        """)
        st.subheader("æ ¸å¿ƒæ£€æŸ¥")
        render_table("dry_eye_tests")

# --- è§’è†œ ---
elif page.startswith("2"):
    st.title("ğŸ‘ï¸ æ¨¡å—äºŒï¼šè§’è†œäº”å±‚æ¥¼")
    st.markdown("")
    
    render_table("cornea_layers")
    box("mnemonic", "å†ç”Ÿå£è¯€", KB["mnemonics"][3])
    
    st.subheader("ç”Ÿç†æœºåˆ¶")
    st.markdown("- **é€æ˜æ€§**ï¼šèƒ¶åŸçº¤ç»´è§„åˆ™æ’åˆ— + æ— è¡€ç®¡ + å†…çš®æ³µè„±æ°´ã€‚")
    st.markdown("- **è¥å…»**ï¼šæ°§æ°”æ¥è‡ªæ³ªè†œï¼ˆççœ¼æ—¶ï¼‰ï¼Œè‘¡è„ç³–æ¥è‡ªæˆ¿æ°´ã€‚")

# --- çº¢çœ¼ ---
elif page.startswith("3"):
    st.title("ğŸ”´ æ¨¡å—ä¸‰ï¼šçº¢çœ¼é‰´åˆ«")
    st.markdown("")
    
    blind = st.toggle("ğŸ›¡ï¸ é®æŒ¡æ¨¡å¼ (Self-Test)")
    render_table("red_eye", blind)
    
    box("mech", "ä¸ºä»€ä¹ˆç»“è†œå……è¡€æ¨å¾—åŠ¨ï¼Ÿ", "è¡€ç®¡ä½äºç–æ¾çš„ç»“è†œå›ºæœ‰å±‚ï¼ˆè¡¨æµ…ï¼‰ã€‚è€Œç«çŠ¶å……è¡€æºè‡ªå·©è†œæ·±å±‚ï¼Œä½ç½®å›ºå®šã€‚")
    box("tip", "æ··åˆå……è¡€", "ä¸¥é‡è§’è†œç‚æˆ–å…¨è‘¡è„è†œç‚æ—¶ï¼Œä¸¤è€…å¯åŒæ—¶å­˜åœ¨ã€‚")

# --- è§’è†œç‚ ---
elif page.startswith("4"):
    st.title("ğŸ¦  æ¨¡å—å››ï¼šè§’è†œç‚ä½“ç³»")
    
    st.subheader("1. å››å¤§ç—…åŸä½“é‰´åˆ«")
    st.markdown("çœ‹åˆ°â€œç¾½æ¯›çŠ¶â€é€‰çœŸèŒï¼Œçœ‹åˆ°â€œæ ‘æçŠ¶â€é€‰ç—…æ¯’ã€‚")
    blind = st.toggle("ğŸ›¡ï¸ é®æŒ¡ç­”æ¡ˆ")
    render_table("keratitis", blind)
    
    col1, col2 = st.columns(2)
    with col1:
        box("pitfall", "æ­»åˆ‘é¢˜", "HSVç—…æ¯’æ€§è§’è†œç‚ï¼ˆä¸Šçš®å‹/æ ‘æçŠ¶ï¼‰**ç»å¯¹ç¦æ­¢**ä½¿ç”¨æ¿€ç´ ï¼å¦åˆ™ç©¿å­”ã€‚")
    with col2:
        box("tip", "æ£˜é˜¿ç±³å·´", "å…³é”®è¯ï¼šéšå½¢çœ¼é•œ + è‡ªæ¥æ°´ã€‚ç‰¹å¾ï¼šå‰§çƒˆç–¼ç—›ä¸ä½“å¾åˆ†ç¦»ï¼ˆç—›å¾—æ‰“æ»šï¼Œè§’è†œçœ‹ç€è¿˜è¡Œï¼‰ã€‚")

# --- ç™½å†…éšœ ---
elif page.startswith("5"):
    st.title("â˜ï¸ æ¨¡å—äº”ï¼šç™½å†…éšœå…¨è§£æ")
    
    st.subheader("1. çš®è´¨æ€§ç™½å†…éšœå››æœŸ")
    st.markdown("")
    render_table("cataract_stages")
    box("mech", "å¹¶å‘æ€§é’å…‰çœ¼æœºåˆ¶", 
        "- **è†¨èƒ€æœŸ**ï¼šæ™¶ä½“å˜å¤§ -> é¡¶ä½è™¹è†œ -> æˆ¿è§’å…³é—­ (é—­è§’å‹)ã€‚\n"
        "- **è¿‡ç†ŸæœŸ**ï¼šè›‹ç™½æ¼å‡º -> å µå¡å°æ¢ç½‘ -> æ™¶çŠ¶ä½“æº¶è§£æ€§ (å¼€è§’å‹)ã€‚")
    
    st.subheader("2. æ™¶çŠ¶ä½“è„±ä½")
    render_table("lens_dislocation")
    box("mnemonic", "è„±ä½æ–¹å‘", KB["mnemonics"][5])

# --- é’å…‰çœ¼ ---
elif page.startswith("6"):
    st.title("ğŸŒ‘ æ¨¡å—å…­ï¼šé’å…‰çœ¼æœºåˆ¶")
    
    tab1, tab2 = st.tabs(["å¼€è§’ vs é—­è§’", "è§†ç¥ç»ä¸è§†é‡"])
    
    with tab1:
        st.subheader("å®šä¹‰ä¸æœºåˆ¶")
        render_table("glaucoma_type")
        box("concept", "å½¢è±¡æ¯”å–»", "é—­è§’å‹ = é—¨å…³äº†ï¼›å¼€è§’å‹ = ä¸‹æ°´é“å µäº†ã€‚")
        
    with tab2:
        st.subheader("è§†ç¥ç»æŸå®³ (Optic Nerve)")
        st.markdown("")
        render_table("optic_nerve")
        box("mech", "ISNTæ³•åˆ™", "æ­£å¸¸ç›˜æ²¿åšåº¦ï¼šä¸‹>ä¸Š>é¼»>é¢ã€‚é’å…‰çœ¼ç ´åè¿™ä¸ªè§„å¾‹ï¼Œç›˜æ²¿å˜çª„ã€‚")
        
        st.subheader("è§†é‡ç¼ºæŸæ¼”å˜")
        st.code("æ—ä¸­å¿ƒæš—ç‚¹ -> é¼»ä¾§é˜¶æ¢¯ -> å¼“å½¢æš—ç‚¹ -> ç¯å½¢æš—ç‚¹ -> ç®¡çŠ¶è§†é‡ -> é¢ä¾§è§†å²›")

# --- è‘¡è„è†œç‚ ---
elif page.startswith("7"):
    st.title("ğŸ”¥ æ¨¡å—ä¸ƒï¼šè‘¡è„è†œç‚ (Uveitis)")
    
    st.subheader("1. SUNåˆ†ç±»æ³•")
    render_table("uveitis_class")
    
    st.subheader("2. è‡ªèº«å…ç–«æ€§â€œå››å¤§é‡‘åˆšâ€")
    box("concept", "HLA-B27ç›¸å…³", "å¹´è½»ç”·æ€§ + å¼ºç›´æ€§è„ŠæŸ±ç‚(AS) + æ€¥æ€§å‰è‘¡ã€‚")
    box("concept", "ç™½å¡ç—… (Behcet)", "å£è…”æºƒç–¡ + å¤–é˜´æºƒç–¡ + æ¸¸èµ°æ€§å‰æˆ¿ç§¯è„“ã€‚")
    box("concept", "VKHç»¼åˆå¾", "æ™šéœçŠ¶çœ¼åº• + ç™½å‘/ç™½ç™œé£ + å¬åŠ›ä¸‹é™ + åŒçœ¼å…¨è‘¡ã€‚")
    box("concept", "äº¤æ„Ÿæ€§çœ¼ç‚", "ä¸€çœ¼ç©¿é€šä¼¤åï¼Œå¦ä¸€çœ¼ï¼ˆ2å‘¨-2æœˆï¼‰å‘ç‚ã€‚")
    
    st.subheader("3. å¿…è€ƒï¼šçº¢çœ¼ä¸‰å¤§é­”å¤´é‰´åˆ«")
    render_table("red_eye_3_demons")

# --- çœ¼å¤–ä¼¤ ---
elif page.startswith("8"):
    st.title("ğŸš‘ æ¨¡å—å…«ï¼šçœ¼å¤–ä¼¤æ€¥æ•‘")
    
    st.subheader("1. åŒ–å­¦çƒ§ä¼¤")
    box("pitfall", "æ€¥æ•‘åŸåˆ™", "äº‰åˆ†å¤ºç§’ï¼Œ**å°±åœ°å†²æ´—**ï¼è‡³å°‘30åˆ†é’Ÿã€‚é…¸å‡å›ºï¼ˆæœ‰å±éšœï¼‰ï¼Œç¢±æº¶è§£ï¼ˆæ·±ç©¿é€ï¼Œæ›´é‡ï¼‰ã€‚")
    
    st.subheader("2. é’æŒ«ä¼¤ (éš”å±±æ‰“ç‰›)")
    render_table("trauma_contusion")
    box("tip", "Berlinæ°´è‚¿", "è§†ç½‘è†œéœ‡è¡ï¼Œé»„æ–‘æ¨±æ¡ƒçº¢æ–‘ï¼Œå¯è‡ªæ„ˆã€‚")

# --- è§†ç½‘è†œ ---
elif page.startswith("9"):
    st.title("ğŸ©º æ¨¡å—ä¹ï¼šè§†ç½‘è†œä¸çœ¼åº•")
    st.write("åŸºäºæ–‡æ¡£ä¸­æ•£è½çš„çœ¼åº•è€ƒç‚¹æ•´ç†ï¼š")
    
    st.markdown("""
    * **é»„æ–‘æ¨±æ¡ƒçº¢æ–‘**ï¼šè§äº è§†ç½‘è†œä¸­å¤®åŠ¨è„‰é˜»å¡ (CRAO) æˆ– è§†ç½‘è†œéœ‡è¡ã€‚
    * **è„‰ç»œè†œç ´è£‚**ï¼šè§†ç›˜å‘¨å›´æ–°æœˆå½¢é»„ç™½è‰²è£‚éš™ã€‚
    * **æ™šéœçŠ¶çœ¼åº•**ï¼šVKHç»¼åˆå¾ï¼ˆè‰²ç´ è„±å¤±ï¼‰ã€‚
    * **æŠ«è¨é¥¼æ ·çœ¼åº•**ï¼šCMVè§†ç½‘è†œç‚ï¼ˆè‰¾æ»‹ç—…ï¼‰ã€‚
    * **è§†ç›˜æ°´è‚¿**ï¼šé¢…å†…å‹å¢é«˜ã€‚
    """)

# --- æ²»ç–— ---
elif page.startswith("10"):
    st.title("ğŸ’Š æ¨¡å—åï¼šæ ¸å¿ƒè¯ç‰©")
    
    c1, c2 = st.columns(2)
    with c1:
        st.subheader("æ•£ç³è¯ (Mydriatics)")
        st.info("**é˜¿æ‰˜å“ (Atropine)**")
        st.write("ä½œç”¨ï¼šéº»ç—¹ç«çŠ¶è‚Œï¼Œå¼ºåŠ›æ•£ç³ã€‚")
        st.write("ç”¨é€”ï¼šè™¹ç«ç‚ (é¦–é€‰ï¼Œé˜²ç²˜è¿)ã€è§’è†œç‚ã€‚")
        st.write("ç¦å¿Œï¼šé’å…‰çœ¼ã€‚")
    with c2:
        st.subheader("ç¼©ç³è¯ (Miotics)")
        st.info("**æ¯›æœèŠ¸é¦™ç¢± (Pilocarpine)**")
        st.write("ä½œç”¨ï¼šæ”¶ç¼©ç³å­”ï¼Œæ‹‰å¼€æˆ¿è§’ã€‚")
        st.write("ç”¨é€”ï¼šé—­è§’å‹é’å…‰çœ¼ã€‚")
        st.write("ç¦å¿Œï¼šè™¹ç«ç‚ã€‚")

# --- å®æˆ˜ ---
elif page.startswith("11"):
    st.title("âš”ï¸ æ¨¡å—åä¸€ï¼šç—…ä¾‹å®æˆ˜")
    
    with st.expander("ç—…ä¾‹ 1ï¼šå†œæ°‘ä¼¯ä¼¯çš„é­é‡", expanded=True):
        st.write("45å²å†œæ°‘ï¼Œæ”¶å‰²ç‰ç±³æ—¶è¢«å¶ç‰‡åˆ’ä¼¤å³çœ¼ã€‚10å¤©åå°±è¯Šï¼Œè§’è†œä¸­å¤®ç°ç™½æºƒç–¡ï¼Œè¡¨é¢å¹²ç‡¥ï¼Œè¾¹ç¼˜å‘ˆç¾½æ¯›çŠ¶ã€‚")
        ans1 = st.radio("ä½ çš„è¯Šæ–­ï¼Ÿ", ["ç»†èŒæ€§", "çœŸèŒæ€§", "HSV"], key="c1")
        if st.button("æäº¤ 1"):
            if ans1 == "çœŸèŒæ€§": st.success("æ­£ç¡®ï¼å…³é”®è¯ï¼šæ¤ç‰©å¤–ä¼¤ + ç¾½æ¯›çŠ¶/å¹²ç‡¥ã€‚")
            else: st.error("é”™è¯¯ã€‚")

    with st.expander("ç—…ä¾‹ 2ï¼šè…°ç—›çš„å¹´è½»äºº"):
        st.write("25å²ç”·æ€§ï¼Œæ™¨èµ·è…°éª¶éƒ¨ç–¼ç—›3å¹´ã€‚ç°å³çœ¼çº¢ç—›ã€‚æŸ¥ä½“ï¼šç«çŠ¶å……è¡€ï¼ŒKP(+)ã€‚")
        ans2 = st.radio("æœ€å¯èƒ½çš„å…³è”ç–¾ç—…ï¼Ÿ", ["ç™½å¡ç—…", "å¼ºç›´æ€§è„ŠæŸ±ç‚", "RA"], key="c2")
        if st.button("æäº¤ 2"):
            if ans2 == "å¼ºç›´æ€§è„ŠæŸ±ç‚": st.success("æ­£ç¡®ï¼HLA-B27ç›¸å…³ã€‚")

# --- å£è¯€ ---
elif page.startswith("12"):
    st.title("ğŸ’ æ¨¡å—åäºŒï¼šå£è¯€æ±‡æ€»")
    for m in KB["mnemonics"]:
        box("mnemonic", "è®°", m)

# ==========================================
# åº•éƒ¨
# ==========================================
st.markdown("---")
st.caption("Â© 2025 OphthPro | å†…å®¹å®Œå…¨åŸºäºç”¨æˆ·ä¸Šä¼ æ–‡æ¡£æ•´ç†")
