import streamlit as st
import pandas as pd
import random

# ==========================================
# 1. é¡µé¢é…ç½®ä¸è‡ªå®šä¹‰æ ·å¼
# ==========================================
st.set_page_config(
    page_title="çœ¼ç§‘å…¨è€ƒç‚¹å¤ä¹ ç«™ (OphthLogic)",
    page_icon="ğŸ‘ï¸",
    layout="wide",
    initial_sidebar_state="expanded"
)

# æ³¨å…¥CSSï¼šä¼˜åŒ–é˜…è¯»ä½“éªŒ
st.markdown("""
<style>
    /* å…¨å±€å­—ä½“ */
    .stApp { font-family: 'Helvetica Neue', 'Microsoft YaHei', sans-serif; }
    
    /* é‡ç‚¹é«˜äº®å— (High Yield) */
    .highlight-box { 
        background-color: #e3f2fd; 
        padding: 15px; 
        border-radius: 8px; 
        border-left: 5px solid #2196f3; 
        margin-bottom: 15px;
        color: #0d47a1;
    }
    
    /* å£è¯€å— (Mnemonics) */
    .mnemonic-box {
        background-color: #fff9c4;
        padding: 15px;
        border-radius: 8px;
        border: 2px dashed #fbc02d;
        font-style: italic;
        margin-bottom: 15px;
        color: #5d4037;
    }
    
    /* é™·é˜±/è­¦ç¤ºå— (Pitfalls) */
    .pitfall-box {
        background-color: #ffebee;
        padding: 15px;
        border-radius: 8px;
        border-left: 5px solid #f44336;
        margin-bottom: 15px;
        color: #b71c1c;
    }

    /* æœºåˆ¶è§£æå— (Mechanism) */
    .mech-box {
        background-color: #f3e5f5;
        padding: 15px;
        border-radius: 8px;
        border-left: 5px solid #9c27b0;
        margin-bottom: 15px;
    }

    .section-title { font-size: 22px; font-weight: bold; color: #333; margin-top: 25px; margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 5px;}
</style>
""", unsafe_allow_html=True)

# ==========================================
# 2. æ ¸å¿ƒçŸ¥è¯†åº“ (KNOWLEDGE_BASE)
#    å°†æ–‡æ¡£æ‰€æœ‰æ–‡æœ¬ç»“æ„åŒ–ï¼Œæ–¹ä¾¿å‰ç«¯è°ƒç”¨
# ==========================================

KB = {
    # --- å£è¯€åº“ ---
    "mnemonics": [
        "ã€ç»“è†œå……è¡€ã€‘ç»“è†œé²œçº¢ç©¹éš†èµ·ï¼Œæ¨ä¹‹èƒ½åŠ¨è‚¾ä¸Šæ¶ˆï¼Œåˆ†æ³Œç‰©å¤šè§†åŠ›å¥½ã€‚",
        "ã€ç«çŠ¶å……è¡€ã€‘ç«çŠ¶ç´«çº¢è§’è†œç»•ï¼Œæ¨ä¹‹ä¸åŠ¨éš¾æ¶ˆé€€ï¼Œç—›ç•æµæ³ªè§†åŠ›æ‰ã€‚",
        "ã€æ³ªè†œç»“æ„ã€‘å¤–æ²¹ä¸­æ°´å†…é»è†œï¼ˆç‘æ¿è…º-æ³ªè…º-æ¯çŠ¶ç»†èƒï¼‰ï¼›æ²¹é˜²è’¸å‘ï¼Œæ°´ä¾›è¥å…»ï¼Œé»æŠ“è§’è†œã€‚",
        "ã€æ³ªæ¶²æµå‘ã€‘ç‚¹ã€å°ã€æ€»ã€å›Šã€é¼»ã€ä¸‹ï¼ˆæœ€åæµè¿›ä¸‹é¼»é“ï¼‰ã€‚",
        "ã€è§’è†œå†ç”Ÿã€‘ä¸Šçš®å†ç”Ÿä¸ç•™ç—•ï¼Œå‰å¼¹åŸºè´¨ç•™ç–¤ç—•ï¼›åå¼¹åšéŸ§é˜²ç©¿å­”ï¼Œå†…çš®åªå¤§ä¸ç”Ÿäººã€‚",
        "ã€è§’è†œç‚é‰´åˆ«ã€‘ç»†èŒæ€¥ï¼Œè„“æ€§å¤šï¼›çœŸèŒç¼“ï¼Œç¾½æ¯›æ‰©ï¼›ç—…æ¯’å¤ï¼Œæ ‘æé•¿ï¼Œæ¿€ç´ ä¸€ç”¨ç©¿å­”å¿™ã€‚",
        "ã€æ™¶çŠ¶ä½“è„±ä½ã€‘Marfan é«˜å¯Œå¸…ï¼Œçœ¼ç›å¾€ä¸Šçœ‹ï¼ˆå¤–ä¸Šæ–¹ï¼‰ï¼›åŒå‹ å‚»ç™½ç”œï¼Œçœ¼ç›å¾€ä¸‹çœ‹ï¼ˆå†…ä¸‹æ–¹ï¼‰ã€‚",
        "ã€ç™½å†…éšœã€‘çš®è´¨ç™½å†…éšœï¼šåˆå‘æ¥”å½¢ï¼Œè†¨èƒ€é’å…‰ï¼ˆé—­è§’ï¼‰ï¼Œæˆç†Ÿå…¨ç™½ï¼Œè¿‡ç†Ÿæº¶è§£ï¼ˆå¼€è§’ï¼‰ã€‚",
        "ã€çœ¼å¤–ä¼¤ã€‘å‰æˆ¿çº¢ç—›ç•å…‰æ³ªï¼Œä¸­é—´é£èšŠé›ªçƒé£ï¼Œåéƒ¨æ— ç—›è§†åŠ›é€€ã€‚",
        "ã€è‘¡è„è†œç‚ã€‘è…°ç–¼B27ç”·å‰æˆ¿ï¼Œå£è…”æºƒç–¡ç™½å¡å¿™ï¼Œæ™šéœç™½å‘VKHï¼Œå¤–ä¼¤åŒçœ¼äº¤æ„Ÿä¼¤ã€‚"
    ],

    # --- æ¨¡å—1ï¼šæ³ªæ¶²ç³»ç»Ÿ ---
    "tear_system": {
        "layers": {
            "columns": ["å±‚æ¬¡", "åç§°", "ä¸»è¦æ¥æº", "åŠŸèƒ½", "å¼‚å¸¸è¡¨ç° (è€ƒç‚¹)"],
            "data": [
                ["å¤–å±‚", "è„‚è´¨å±‚", "ç‘æ¿è…º (MGD)", "é˜²è’¸å‘ã€å¢åŠ è¡¨é¢å¼ åŠ›", "è’¸å‘è¿‡å¼ºå‹å¹²çœ¼ï¼ŒBUTç¼©çŸ­"],
                ["ä¸­å±‚", "æ°´æ¶²å±‚", "ä¸»/å‰¯æ³ªè…º", "ä¾›æ°§ã€è¥å…»ã€æŠ—èŒã€å†²æ´—", "æ°´æ¶²ç¼ºä¹å‹å¹²çœ¼ (Sjogren)"],
                ["å†…å±‚", "é»è›‹ç™½å±‚", "ç»“è†œæ¯çŠ¶ç»†èƒ", "äº²æ°´ç•Œé¢ï¼ˆåŒé¢èƒ¶ï¼‰", "æ³ªæ¶²æ— æ³•é“ºå±•ï¼Œå½¢æˆå¹²æ–‘"]
            ]
        },
        "dry_eye_class": {
            "columns": ["ç±»å‹", "æœºåˆ¶", "å¸¸è§ç—…å› "],
            "data": [
                ["æ°´æ¶²ç¼ºä¹å‹ (ADDE)", "æ³ªè…ºåˆ†æ³Œâ€œæ°´â€ä¸å¤Ÿ", "Sjogrenç»¼åˆå¾ (SS)ã€ç±»é£æ¹¿ (RA)ã€SLE"],
                ["è’¸å‘è¿‡å¼ºå‹ (EDE)", "æ°´å¤Ÿä½†é”ä¸ä½ (æ²¹å°‘)", "ç‘æ¿è…ºåŠŸèƒ½éšœç¢ (MGDï¼Œæœ€å¸¸è§)ã€è§†é¢‘ç»ˆç«¯ç»¼åˆå¾ (VDT)ã€çœ¼ç‘é—­åˆä¸å…¨"]
            ]
        },
        "dry_eye_tests": {
            "columns": ["æ£€æŸ¥é¡¹ç›®", "æ­£å¸¸å€¼", "ä¸´åºŠæ„ä¹‰"],
            "data": [
                ["BUT (æ³ªè†œç ´è£‚æ—¶é—´)", "> 10ç§’", "åæ˜ æ³ªè†œç¨³å®šæ€§ï¼ˆæ²¹å±‚/é»è›‹ç™½å±‚ï¼‰ã€‚MGDå…¸å‹è¡¨ç°ã€‚"],
                ["Schirmer I è¯•éªŒ", "> 10mm/5min", "åæ˜ æ€»åˆ†æ³Œé‡ï¼ˆåŸºç¡€+åå°„ï¼‰ã€‚SSå…¸å‹è¡¨ç°ã€‚"],
                ["è§å…‰ç´ æŸ“è‰² (FL)", "é˜´æ€§", "é˜³æ€§æç¤ºè§’è†œä¸Šçš®ç¼ºæŸ (PEE)ã€‚"]
            ]
        }
    },

    # --- æ¨¡å—2ï¼šè§’è†œ ---
    "cornea": {
        "layers": {
            "columns": ["å±‚æ¬¡", "åç§°", "å†ç”Ÿèƒ½åŠ› (æ ¸å¿ƒè€ƒç‚¹)", "ç‰¹ç‚¹"],
            "data": [
                ["1", "ä¸Šçš®ç»†èƒå±‚", "âœ… æå¼ºï¼Œä¸ç•™ç—•", "å¯Œå«ç¥ç»ï¼Œç—›è§‰æ•é”ï¼›24-48hä¿®å¤"],
                ["2", "å‰å¼¹åŠ›å±‚", "âŒ ä¸å¯å†ç”Ÿ", "æŸä¼¤åå½¢æˆäº‘ç¿³/æ–‘ç¿³"],
                ["3", "åŸºè´¨å±‚", "âŒ ä¸å¯å†ç”Ÿ", "æœ€åš(90%)ï¼Œè§„åˆ™æ’åˆ—æ˜¯é€æ˜åŸºç¡€"],
                ["4", "åå¼¹åŠ›å±‚", "âœ… å¯å†ç”Ÿ", "åšéŸ§ï¼Œè€ä¾µèš€ (Descemetoceleè†¨å‡º)"],
                ["5", "å†…çš®ç»†èƒå±‚", "âŒ ä¸å¯å†ç”Ÿ (åªå¤§ä¸ç”Ÿäºº)", "æ³µåŠŸèƒ½ç»´æŒè„±æ°´ï¼›<500æ—¶å¤±ä»£å¿æ°´è‚¿"]
            ]
        },
        "keratitis": {
            "columns": ["é‰´åˆ«ç‚¹", "ç»†èŒæ€§", "çœŸèŒæ€§", "ç—…æ¯’æ€§ (HSV)", "æ£˜é˜¿ç±³å·´"],
            "data": [
                ["ç—…å²", "å¤–ä¼¤ã€æˆ´éšå½¢ã€å€’ç«", "æ¤ç‰©å¤–ä¼¤ (ç‰ç±³å¶/æ ‘æ)", "æ„Ÿå†’å‘çƒ­åå¤å‘", "éšå½¢çœ¼é•œ+è‡ªæ¥æ°´å†²æ´—"],
                ["èµ·ç—…", "æ€¥ (24hå‰§å˜)", "ç¼“ (äºšæ€¥æ€§)", "åå¤å‘ä½œ", "æ…¢"],
                ["ç—‡çŠ¶", "å‰§ç—›ã€è„“å¤š", "ç—‡çŠ¶è½»ã€ä½“å¾é‡ (åˆ†ç¦»)", "ç—›æ„Ÿè½» (çŸ¥è§‰å‡é€€)", "å‰§ç—› (ä¸ä½“å¾åˆ†ç¦»)"],
                ["æºƒç–¡ç‰¹å¾", "æ¹¿æ¶¦ã€è¾¹ç•Œä¸æ¸…", "å¹²ç‡¥ã€ç‰™è†æ ·ã€è¾¹ç•Œæ¸…", "æ ‘æçŠ¶ã€åœ°å›¾çŠ¶", "æ”¾å°„çŠ¶ç¥ç»ç‚"],
                ["ç‰¹æœ‰ä½“å¾", "å‰æˆ¿ç§¯è„“(æµåŠ¨)", "ç¾½æ¯›çŠ¶ã€å«æ˜Ÿç¶ã€èŒä¸è‹”è¢«", "æœ«ç«¯è†¨å¤§", "ç¯å½¢æµ¸æ¶¦"],
                ["æ²»ç–—", "å·¦æ°§/å¦¥å¸ƒéœ‰ç´  (é¢‘ç¹)", "çº³ä»–éœ‰ç´  (å¿Œæ¿€ç´ )", "æ›´æ˜”æ´›éŸ¦ (å¿Œæ¿€ç´ )", "æ°¯å·±å®š"]
            ]
        }
    },

    # --- æ¨¡å—3ï¼šçº¢çœ¼é‰´åˆ« ---
    "red_eye": {
        "columns": ["é‰´åˆ«ç‚¹", "ç»“è†œå……è¡€ (Conjunctival)", "ç«çŠ¶å……è¡€ (Ciliary)"],
        "data": [
            ["è¡€ç®¡æ¥æº", "ç»“è†œååŠ¨è„‰ (æµ…)", "ç«çŠ¶å‰åŠ¨è„‰ (æ·±)"],
            ["å¤–è§‚", "é²œçº¢è‰²ï¼Œæ ‘æç½‘çŠ¶", "ç´«çº¢è‰²ï¼Œæ¯›åˆ·/æ”¾å°„çŠ¶"],
            ["éƒ¨ä½", "ç©¹éš†éƒ¨æ˜æ˜¾ï¼Œå‘è§’è†œå˜æ·¡", "è§’è†œç¼˜æ˜æ˜¾ï¼Œå‘åå˜æ·¡"],
            ["ç§»åŠ¨æ€§", "æ¨å¾—åŠ¨", "æ¨ä¸åŠ¨"],
            ["è‚¾ä¸Šè…ºç´ ", "æ•æ„Ÿ (ç«‹å³å˜ç™½)", "ä¸æ•æ„Ÿ"],
            ["ä¼´éšç—‡çŠ¶", "åˆ†æ³Œç‰©å¤šï¼Œè§†åŠ›å¥½", "ç—›ã€ç•å…‰ã€æµæ³ªï¼Œè§†åŠ›é™"],
            ["å¸¸è§ç—…", "ç»“è†œç‚", "è§’è†œç‚ã€è™¹ç«ç‚ã€é’å…‰çœ¼"]
        ]
    },

    # --- æ¨¡å—4ï¼šç™½å†…éšœä¸æ™¶çŠ¶ä½“ ---
    "cataract": {
        "stages": {
            "columns": ["åˆ†æœŸ", "å…³é”®ç‰¹å¾", "å¹¶å‘ç—‡/è€ƒç‚¹"],
            "data": [
                ["åˆå‘æœŸ", "æ¥”å½¢æ··æµŠ", "ä¸å½±å“è§†åŠ›"],
                ["è†¨èƒ€æœŸ", "æ™¶ä½“å¸æ°´è‚¿èƒ€", "è¯±å‘ã€æ€¥æ€§é—­è§’å‹é’å…‰çœ¼ã€‘ (é—¨å…³äº†)"],
                ["æˆç†ŸæœŸ", "å®Œå…¨æ··æµŠ", "çœ¼åº•çœ‹ä¸è§"],
                ["è¿‡ç†ŸæœŸ", "çš®è´¨æ¶²åŒ–ã€æ ¸ä¸‹æ²‰", "è¯±å‘ã€æ™¶çŠ¶ä½“æº¶è§£æ€§é’å…‰çœ¼ã€‘ (ä¸‹æ°´é“å µäº†)"]
            ]
        },
        "causes": {
            "columns": ["ç±»å‹", "å…¸å‹ç‰¹å¾"],
            "data": [
                ["è€å¹´æ€§", "æœ€å¸¸è§ï¼Œçš®è´¨æ€§/æ ¸æ€§/åå›Šä¸‹"],
                ["ç³–å°¿ç—…æ€§", "é›ªèŠ±çŠ¶æ··æµŠï¼Œè¿›å±•å¿«"],
                ["è¯ç‰©æ€§ (æ¿€ç´ )", "åå›Šä¸‹æ··æµŠ"],
                ["å¤–ä¼¤æ€§", "ç«ç‘°èŠ±ç»“çŠ¶ (Rosette)"]
            ]
        },
        "dislocation": {
            "columns": ["ç–¾ç—…", "é—ä¼ æ–¹å¼", "è„±ä½æ–¹å‘", "ä½“å‹ç‰¹å¾"],
            "data": [
                ["Marfanç»¼åˆå¾", "å¸¸æ˜¾ (AD)", "é¢ä¸Šæ–¹ (Up-Out)", "é«˜ç˜¦ã€æŒ‡ç»†é•¿ã€ä¸»åŠ¨è„‰å¤¹å±‚"],
                ["åŒå‹åŠèƒ±æ°¨é…¸å°¿ç—‡", "å¸¸éš (AR)", "é¼»ä¸‹æ–¹ (Down-In)", "éª¨è´¨ç–æ¾ã€æ™ºåŠ›ä½ã€æ˜“è¡€æ “"],
                ["Weill-Marchesani", "å¸¸éš (AR)", "ä¸‹æ–¹", "èº«æçŸ®å°ã€çŸ­æŒ‡"]
            ]
        }
    },

    # --- æ¨¡å—5ï¼šè‘¡è„è†œç‚ ---
    "uveitis": {
        "class": {
            "columns": ["ç±»å‹", "ä¸»æˆ˜åœº", "ç‰¹å¾æ€§ä½“å¾"],
            "data": [
                ["å‰è‘¡è„è†œç‚", "å‰æˆ¿ (è™¹è†œ/ç«çŠ¶ä½“)", "KP (å°˜çŠ¶/ç¾Šè„‚çŠ¶)ã€æˆ¿æ°´é—ªè¾‰ (Tyndall)ã€ç³å­”ç¼©å°"],
                ["ä¸­é—´è‘¡è„è†œç‚", "ç»ç’ƒä½“", "é›ªçƒçŠ¶æ··æµŠ (Snowballs)ã€é£èšŠç—‡"],
                ["åè‘¡è„è†œç‚", "è§†ç½‘è†œ/è„‰ç»œè†œ", "çœ¼åº•ç—…ç¶ã€æ— ç—›æ€§è§†åŠ›ä¸‹é™"],
                ["å…¨è‘¡è„è†œç‚", "å…¨å±‚", "ç—…æƒ…æœ€é‡"]
            ]
        },
        "immune": [
            "**HLA-B27ç›¸å…³**ï¼šå¹´è½»ç”·æ€§ + å¼ºç›´æ€§è„ŠæŸ±ç‚ (AS) + æ€¥æ€§å‰è‘¡ã€‚",
            "**ç™½å¡ç—… (Behcet)**ï¼šå£è…”æºƒç–¡ + å¤–é˜´æºƒç–¡ + æ¸¸èµ°æ€§å‰æˆ¿ç§¯è„“ã€‚",
            "**VKHç»¼åˆå¾**ï¼šæ™šéœçŠ¶çœ¼åº• + ç™½å‘/ç™½ç™œé£ + å¬åŠ›ä¸‹é™ + åŒçœ¼å…¨è‘¡ã€‚",
            "**äº¤æ„Ÿæ€§çœ¼ç‚**ï¼šä¸€çœ¼ç©¿é€šä¼¤åï¼Œå¦ä¸€çœ¼ï¼ˆ2å‘¨-2æœˆï¼‰å‘ç”Ÿè‘¡è„è†œç‚ã€‚"
        ]
    },

    # --- æ¨¡å—6ï¼šçœ¼å¤–ä¼¤ ---
    "trauma": {
        "chemical": {
            "title": "åŒ–å­¦ä¼¤æ€¥æ•‘ (Chemical Burn)",
            "content": "**äº‰åˆ†å¤ºç§’ï¼Œå°±åœ°å†²æ´—ï¼**\n- å†²æ´—è‡³å°‘30åˆ†é’Ÿï¼Œç›´åˆ°pHå‘ˆä¸­æ€§(7.0-7.2)ã€‚\n- ç¢±çƒ§ä¼¤æ¯”é…¸çƒ§ä¼¤æ›´ä¸¥é‡ï¼ˆæº¶è§£è„‚è‚ªï¼Œå‘æ·±éƒ¨æ¸—é€ï¼‰ã€‚\n- ç¦ç”¨ï¼šæ‚çœ¼ã€ç­‰æ•‘æŠ¤è½¦ã€‚"
        },
        "contusion": {
            "columns": ["æŸä¼¤éƒ¨ä½", "åç§°", "è¡¨ç°ä¸è€ƒç‚¹"],
            "data": [
                ["å‰æˆ¿", "å‰æˆ¿ç§¯è¡€", "åˆ†çº§çœ‹é«˜åº¦ï¼›åŠå§ä½ä¼‘æ¯ï¼›é˜²è§’è†œè¡€æŸ“/é’å…‰çœ¼"],
                ["è™¹è†œ", "æ ¹éƒ¨ç¦»æ–­", "ç³å­”å‘ˆ Då½¢"],
                ["æ™¶çŠ¶ä½“", "è„±ä½", "è™¹è†œéœ‡é¢¤"],
                ["è§†ç½‘è†œ", "è§†ç½‘è†œéœ‡è¡", "Berlinæ°´è‚¿ï¼šé»„æ–‘æ¨±æ¡ƒçº¢ï¼›å¯è‡ªæ„ˆ"],
                ["è„‰ç»œè†œ", "ç ´è£‚", "å¼“å½¢é»„ç™½è‰²è£‚éš™"]
            ]
        },
        "penetrating": {
            "title": "çœ¼çƒç©¿é€šä¼¤ (Penetrating)",
            "content": "- **ä½“å¾**ï¼šçœ¼å‹é™ä½ï¼ˆæ°”æ¼äº†ï¼‰ã€å‰æˆ¿å˜æµ…ã€ç³å­”æ¢¨å½¢ï¼ˆå°–ç«¯æŒ‡ä¼¤å£ï¼‰ã€‚\n- **åŸåˆ™**ï¼šç¼åˆä¼¤å£ï¼Œæ¢å¤çœ¼çƒå®Œæ•´æ€§ï¼Œé˜²æ„ŸæŸ“ã€‚"
        }
    }
}

# ==========================================
# 3. è¾…åŠ©å‡½æ•° (UI Component Rendering)
# ==========================================

def render_table(data_dict, blind_mode=False):
    """æ¸²æŸ“è¡¨æ ¼ï¼Œæ”¯æŒé®æŒ¡æ¨¡å¼"""
    df = pd.DataFrame(data_dict["data"], columns=data_dict["columns"])
    if blind_mode:
        # é®æŒ¡é™¤ç¬¬ä¸€åˆ—å¤–çš„æ‰€æœ‰å†…å®¹
        st.dataframe(df.iloc[:, [0]], use_container_width=True)
        st.caption("ğŸ™ˆ é®æŒ¡æ¨¡å¼å¼€å¯ä¸­... è¯·å°è¯•å›å¿†è¯¦ç»†å†…å®¹")
    else:
        st.dataframe(df, use_container_width=True)

def render_box(type, title, text):
    if type == "highlight":
        st.markdown(f'<div class="highlight-box"><b>ğŸ“Œ {title}</b><br>{text}</div>', unsafe_allow_html=True)
    elif type == "pitfall":
        st.markdown(f'<div class="pitfall-box">âš ï¸ <b>{title}</b><br>{text}</div>', unsafe_allow_html=True)
    elif type == "mech":
        st.markdown(f'<div class="mech-box">âš™ï¸ <b>{title}</b><br>{text}</div>', unsafe_allow_html=True)
    elif type == "mnemonic":
        st.markdown(f'<div class="mnemonic-box">ğŸ”” <b>è®°å¿†å£è¯€ï¼š</b>{text}</div>', unsafe_allow_html=True)

# ==========================================
# 4. ä¸»ç¨‹åºé€»è¾‘
# ==========================================

# --- ä¾§è¾¹æ  ---
with st.sidebar:
    st.image("https://img.icons8.com/fluency/96/ophthalmology.png", width=70)
    st.title("OphthLogic")
    st.caption("æ–‡æ¡£æ ¸å¿ƒè€ƒç‚¹å…¨è¦†ç›–")
    
    # å¯¼èˆªèœå•
    menu = st.radio(
        "é€‰æ‹©å¤ä¹ ç« èŠ‚ï¼š",
        [
            "ğŸ  é¦–é¡µ (Dashboard)",
            "ğŸ’§ æ¨¡å—ä¸€ï¼šè§£å‰–ç”Ÿç† (æ³ªæ¶²/è§’è†œ)",
            "ğŸ”´ æ¨¡å—äºŒï¼šçº¢çœ¼ä¸è§’è†œç—…",
            "ğŸŒ‘ æ¨¡å—ä¸‰ï¼šæ™¶çŠ¶ä½“ä¸ç™½å†…éšœ",
            "ğŸ”¥ æ¨¡å—å››ï¼šè‘¡è„è†œç‚",
            "ğŸš‘ æ¨¡å—äº”ï¼šçœ¼å¤–ä¼¤",
            "ğŸ’ è€ƒå‰å·¥å…·ç®± (å£è¯€/é‰´åˆ«)"
        ]
    )
    
    st.divider()
    st.info("ğŸ’¡ **Random Mnemonic:**\n" + random.choice(KB["mnemonics"]))

# --- é¡µé¢å†…å®¹è·¯ç”± ---

if "é¦–é¡µ" in menu:
    st.title("ğŸ‘ï¸ çœ¼ç§‘å…¨è€ƒç‚¹å¤ä¹ ç«™")
    st.markdown("### *Slogan: Logic beats Rote Memory. ä»æœºåˆ¶æ¨å¯¼ä¸´åºŠã€‚*")
    st.write("æœ¬ç³»ç»Ÿå·²åŒ…å«æ‚¨ä¸Šä¼ æ–‡æ¡£ä¸­çš„**æ‰€æœ‰æ ¸å¿ƒè€ƒç‚¹**ï¼Œæ¶µç›–è§£å‰–ã€ç—…ç†ã€é‰´åˆ«è¯Šæ–­åŠæ€¥æ•‘åŸåˆ™ã€‚")
    
    col1, col2 = st.columns(2)
    with col1:
        render_box("highlight", "å¤ä¹ å»ºè®®", 
                   "1. **å…ˆè§£å‰–**ï¼šç†è§£æ³ªè†œä¸‰å±‚å’Œè§’è†œäº”å±‚ï¼Œæ˜¯ç†è§£å¹²çœ¼å’Œè§’è†œç‚çš„åŸºç¡€ã€‚\n"
                   "2. **æŠ“é‰´åˆ«**ï¼šçº¢çœ¼é‰´åˆ«è¡¨ã€ç»†èŒçœŸèŒé‰´åˆ«è¡¨æ˜¯å¿…è€ƒé¢˜ã€‚\n"
                   "3. **çœ‹æ€¥æ•‘**ï¼šé…¸ç¢±çƒ§ä¼¤å’Œçœ¼å¤–ä¼¤çš„å¤„ç†åŸåˆ™æ˜¯ä¸´åºŠé‡ç‚¹ã€‚")
    with col2:
        render_box("pitfall", "å¸¸è§è¯¯åŒº", 
                   "- è§†åŠ›ä¸‹é™+çº¢çœ¼ â‰  ç»“è†œç‚ (è­¦æƒ•é’å…‰çœ¼/è§’è†œç‚)\n"
                   "- ç—…æ¯’æ€§è§’è†œç‚ä¸Šçš®æœŸ â‰  ç”¨æ¿€ç´  (ä¼šç©¿å­”ï¼)\n"
                   "- é¼»æ³ªç®¡å¼€å£ â‰  ä¸­é¼»é“ (æ˜¯ä¸‹é¼»é“ï¼)")

elif "æ¨¡å—ä¸€" in menu:
    st.title("ğŸ§¬ æ¨¡å—ä¸€ï¼šè§£å‰–ä¸ç”Ÿç†")
    
    tab1, tab2 = st.tabs(["ğŸ’§ æ³ªæ¶²ä¸å¹²çœ¼ä½“ç³»", "ğŸ‘ï¸ è§’è†œäº”å±‚æ¥¼"])
    
    with tab1:
        st.subheader("1. æ³ªé“è§£å‰–æµå‘")
        st.code("æ³ªå°ç‚¹ â†’ æ³ªå°ç®¡ â†’ æ³ªæ€»ç®¡ â†’ æ³ªå›Š â†’ é¼»æ³ªç®¡ â†’ ä¸‹é¼»é“ (Hasnerç“£)", language="text")
        render_box("pitfall", "è§£å‰–é™·é˜±", "é¼»æ³ªç®¡å¼€å£äº**ä¸‹é¼»é“**ï¼æ–°ç”Ÿå„¿æ³ªå›Šç‚æ˜¯å› ä¸ºHasnerç“£å µå¡ã€‚")
        
        st.subheader("2. æ³ªè†œä¸‰å±‚ç»“æ„ & å¹²çœ¼åˆ†ç±»")
        st.write("å¹²çœ¼ç—‡ä¸ä»…æ˜¯ç¼ºæ°´ï¼Œæ›´æ˜¯æ³ªè†œç¨³æ€å¤±è¡¡ã€‚")
        render_table(KB["tear_system"]["layers"])
        render_box("mech", "ä¸ºä»€ä¹ˆéœ€è¦é»è›‹ç™½ï¼Ÿ", "è§’è†œä¸Šçš®æ˜¯ç–æ°´çš„ï¼Œé»è›‹ç™½åƒ'åŒé¢èƒ¶'ä¸€æ ·ï¼Œä¸€ç«¯æŠ“ä¸Šçš®ï¼Œä¸€ç«¯æŠ“æ°´ï¼Œé˜²æ­¢æ³ªæ¶²æ»‘è½ã€‚")
        
        st.subheader("3. å¹²çœ¼ç—‡ä¸¤å¤§ç±» (ADDE vs EDE)")
        render_table(KB["tear_system"]["dry_eye_class"])
        
        st.subheader("4. å…³é”®æ£€æŸ¥æŒ‡æ ‡")
        render_table(KB["tear_system"]["dry_eye_tests"])

    with tab2:
        st.subheader("1. è§’è†œäº”å±‚ç»“æ„ (The 5 Layers)")
        render_box("mnemonic", KB["mnemonics"][4], "")
        render_table(KB["cornea"]["layers"])
        
        st.subheader("2. é€æ˜æœºåˆ¶")
        st.markdown("- **è§£å‰–**ï¼šèƒ¶åŸçº¤ç»´è§„åˆ™æ’åˆ—ã€æ— è¡€ç®¡ã€‚\n- **ç”Ÿç†**ï¼šå†…çš®æ³µåŠŸèƒ½ç»´æŒè„±æ°´çŠ¶æ€ï¼ˆæ³µè¡°ç«­ -> æ°´è‚¿ï¼‰ã€‚")
        
        st.subheader("3. è¥å…»ä»£è°¢")
        st.write("è§’è†œæ— è¡€ç®¡ï¼Œæ°§æ°”ä¸»è¦æ¥è‡ª**æ³ªè†œ**ï¼ˆççœ¼æ—¶ï¼‰ï¼Œè‘¡è„ç³–ä¸»è¦æ¥è‡ª**æˆ¿æ°´**ã€‚")

elif "æ¨¡å—äºŒ" in menu:
    st.title("ğŸ”´ æ¨¡å—äºŒï¼šçº¢çœ¼ä¸è§’è†œç—…")
    
    blind = st.toggle("ğŸ›¡ï¸ å¼€å¯é®æŒ¡æ¨¡å¼ (Self-Test)")
    
    st.subheader("1. å……è¡€é‰´åˆ« (Red Eye)")
    st.write("çœ‹åˆ°â€œå……è¡€â€äºŒå­—ï¼Œè¿…é€Ÿå»ºç«‹é‰´åˆ«æ ‘ã€‚")
    render_table(KB["red_eye"], blind_mode=blind)
    render_box("mech", "æœºåˆ¶è§£æ", 
               "ç»“è†œè¡€ç®¡æµ…ï¼Œæ‰€ä»¥é²œçº¢ã€æ¨å¾—åŠ¨ã€å¯¹è‚¾ä¸Šè…ºç´ æ•æ„Ÿã€‚\n"
               "ç«çŠ¶è¡€ç®¡æ·±ï¼ˆåœ¨å·©è†œé‡Œï¼‰ï¼Œæ‰€ä»¥ç´«çº¢ã€æ¨ä¸åŠ¨ã€ä¸æ•æ„Ÿã€‚")
    render_box("pitfall", "æ··åˆå……è¡€", "ä¸¥é‡è§’è†œç‚æˆ–å…¨è‘¡è„è†œç‚æ—¶ï¼Œä¸¤è€…å¯åŒæ—¶å­˜åœ¨ã€‚")

    st.markdown("---")
    st.subheader("2. æ„ŸæŸ“æ€§è§’è†œç‚é‰´åˆ«")
    st.write("å…³é”®è¯åŒ¹é…æ³•ï¼šçœ‹åˆ°â€œç¾½æ¯›â€é€‰çœŸèŒï¼Œçœ‹åˆ°â€œæ ‘æâ€é€‰ç—…æ¯’ã€‚")
    render_table(KB["cornea"]["keratitis"], blind_mode=blind)
    
    c1, c2 = st.columns(2)
    with c1:
        render_box("pitfall", "æ¿€ç´ ç¦å¿Œ", "HSVè§’è†œç‚ï¼ˆä¸Šçš®å‹/æ ‘æçŠ¶ï¼‰**ç»å¯¹ç¦ç”¨æ¿€ç´ **ï¼å¦åˆ™ç—…æ¯’æ‰©æ•£å¯¼è‡´ç©¿å­”ã€‚")
    with c2:
        render_box("highlight", "æ²»ç–—åŸåˆ™", 
                   "- **æ•£ç³**ï¼šå‡¡æ˜¯è§’è†œç‚éƒ½è¦æ•£ç³ï¼ˆé˜²ç²˜è¿ã€æ­¢ç—›ï¼‰ã€‚\n"
                   "- **å¿ŒåŒ…æ‰**ï¼šåˆ©äºå‡æ¸©ç»†èŒç¹æ®–ã€‚")

elif "æ¨¡å—ä¸‰" in menu:
    st.title("ğŸŒ‘ æ¨¡å—ä¸‰ï¼šæ™¶çŠ¶ä½“ä¸ç™½å†…éšœ")
    
    tab1, tab2 = st.tabs(["â˜ï¸ ç™½å†…éšœ (Cataract)", "ğŸ”® æ™¶çŠ¶ä½“è„±ä½"])
    
    with tab1:
        st.subheader("1. è€å¹´æ€§çš®è´¨æ€§ç™½å†…éšœå››æœŸ")
        render_table(KB["cataract"]["stages"])
        render_box("highlight", "é’å…‰çœ¼å¹¶å‘ç—‡", 
                   "- **è†¨èƒ€æœŸ** -> æ™¶ä½“è‚¿ -> æˆ¿è§’å…³ -> **æ€¥æ€§é—­è§’å‹é’å…‰çœ¼**\n"
                   "- **è¿‡ç†ŸæœŸ** -> è›‹ç™½æ¼ -> å µå°æ¢ -> **æ™¶çŠ¶ä½“æº¶è§£æ€§é’å…‰çœ¼**")
        
        st.subheader("2. å…¶ä»–ç±»å‹ç™½å†…éšœ")
        render_table(KB["cataract"]["causes"])
        
        st.subheader("3. æ‰‹æœ¯å¹¶å‘ç—‡")
        st.markdown("""
        * **æœ¯ä¸­**ï¼šåå›Šç ´è£‚ (PCR) -> æ ¸æ‰å…¥ç»ç’ƒä½“ã€‚
        * **æœ¯åæ—©æœŸ**ï¼šçœ¼å†…ç‚ (æœ€å‡¶é™©ï¼Œç—›+è§†åŠ›é™+ç§¯è„“)ã€‚
        * **æœ¯åæ™šæœŸ**ï¼šåå‘æ€§ç™½å†…éšœ (PCO) -> æ™¶ä½“ä¸Šçš®å¢ç”Ÿ -> **YAGæ¿€å…‰**æ‰“å­”æ²»ç–—ã€‚
        """)

    with tab2:
        st.subheader("1. æ™¶çŠ¶ä½“å¼‚ä½ä¸å…¨èº«ç—…")
        st.write("å¹´è½»äººæ— å¤–ä¼¤å‡ºç°è„±ä½ï¼Œå¿…æŸ¥å…¨èº«ã€‚")
        render_table(KB["cataract"]["dislocation"])
        render_box("mnemonic", KB["mnemonics"][6], "")
        
        st.subheader("2. å…¸å‹ä½“å¾")
        st.markdown("- **è™¹è†œéœ‡é¢¤ (Iridodonesis)**ï¼šæ™¶ä½“åƒçª—å¸˜ä¸€æ ·æ™ƒåŠ¨ã€‚\n- **å•çœ¼å¤è§†**ï¼šå…‰çº¿ç»è¿‡æ™¶ä½“è¾¹ç¼˜ã€‚")

elif "æ¨¡å—å››" in menu:
    st.title("ğŸ”¥ æ¨¡å—å››ï¼šè‘¡è„è†œç‚ (Uveitis)")
    
    st.subheader("1. æŒ‰è§£å‰–åˆ†ç±» (SUNæ ‡å‡†)")
    render_table(KB["uveitis"]["class"])
    
    st.subheader("2. å…ç–«æ€§è‘¡è„è†œç‚ (å››å¤§é‡‘åˆš)")
    for item in KB["uveitis"]["immune"]:
        st.info(item)
    
    st.subheader("3. æ ¸å¿ƒä½“å¾è§£æ")
    c1, c2 = st.columns(2)
    with c1:
        render_box("mech", "KP (è§’è†œåæ²‰ç€ç‰©)", 
                   "- **å°˜çŠ¶**ï¼šéè‚‰èŠ½è‚¿æ€§ (HLA-B27)\n"
                   "- **ç¾Šè„‚çŠ¶**ï¼šè‚‰èŠ½è‚¿æ€§ (ç»“æ ¸/æ¢…æ¯’)")
    with c2:
        render_box("mech", "Tyndallå¾ (æˆ¿æ°´é—ªè¾‰)", 
                   "ä»£è¡¨è¡€-æˆ¿æ°´å±éšœç ´åï¼Œè›‹ç™½æ¼å‡ºã€‚åƒé˜³å…‰ç…§è¿›æ»¡æ˜¯ç°å°˜çš„å±‹å­ã€‚")

elif "æ¨¡å—äº”" in menu:
    st.title("ğŸš‘ æ¨¡å—äº”ï¼šçœ¼å¤–ä¼¤ (Trauma)")
    
    st.subheader("1. åŒ–å­¦çƒ§ä¼¤ (Chemical Burn)")
    render_box("pitfall", KB["trauma"]["chemical"]["title"], KB["trauma"]["chemical"]["content"])
    st.markdown("- **é¢„ååˆ¤æ–­**ï¼šçœ‹è§’è†œç¼˜ç¼ºè¡€ç¨‹åº¦ï¼ˆè‹ç™½=ç¼ºè¡€=å¹²ç»†èƒåæ­»=é¢„åå·®ï¼‰ã€‚")
    
    st.subheader("2. é’æŒ«ä¼¤ (Contusion)")
    st.write("æœºåˆ¶ï¼šéš”å±±æ‰“ç‰›ã€‚")
    render_table(KB["trauma"]["contusion"])
    
    st.subheader("3. ç©¿é€šä¼¤ (Penetrating)")
    st.info(KB["trauma"]["penetrating"]["content"])

elif "å·¥å…·ç®±" in menu:
    st.title("ğŸ’ è€ƒå‰å·¥å…·ç®±")
    
    st.subheader("ğŸ“œ å®Œæ•´å£è¯€åº“")
    for m in KB["mnemonics"]:
        st.success(m)
        
    st.markdown("---")
    st.subheader("ğŸ’Š æ ¸å¿ƒè¯ç‰©é€ŸæŸ¥")
    st.markdown("""
    | è¯ç‰© | ä½œç”¨ | é€‚åº”ç—‡ | ç¦å¿Œ |
    | :--- | :--- | :--- | :--- |
    | **é˜¿æ‰˜å“** | æ•£ç³ã€éº»ç—¹ç«çŠ¶è‚Œ | è§’è†œç‚ã€è™¹ç«ç‚ (é˜²ç²˜è¿) | é’å…‰çœ¼ |
    | **æ¯›æœèŠ¸é¦™ç¢±** | ç¼©ç³ã€æ‹‰å¼€æˆ¿è§’ | é—­è§’å‹é’å…‰çœ¼ | è™¹ç«ç‚ |
    | **ç³–çš®è´¨æ¿€ç´ ** | æŠ—ç‚ã€å…ç–«æŠ‘åˆ¶ | è‘¡è„è†œç‚ã€åŸºè´¨å‹è§’è†œç‚ | **ç—…æ¯’æ€§è§’è†œç‚ä¸Šçš®æœŸ**ã€çœŸèŒæ„ŸæŸ“ |
    | **çº³ä»–éœ‰ç´ ** | æŠ—çœŸèŒ | çœŸèŒæ€§è§’è†œç‚ | - |
    """)

# ==========================================
# 5. åº•éƒ¨ç‰ˆæƒä¿¡æ¯
# ==========================================
st.markdown("---")
st.caption("Â© 2025 OphthLogic Review System | Based on Uploaded Documents")
